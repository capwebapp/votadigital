<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administraci√≥n - Votaci√≥n Escolar</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; color: #1e293b; line-height: 1.6; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .login-box { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 400px; }
    .login-box h2 { margin-bottom: 1rem; }
    .login-box input { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 2px solid #e2e8f0; border-radius: 0.375rem; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-secondary { background: #64748b; color: white; }
    .btn-info { background: #06b6d4; color: white; }
    .btn-purple { background: #8b5cf6; color: white; }

    .header { background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .admin-nav { background: #1e293b; padding: 1rem; margin: 0 -1rem 2rem -1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .admin-nav button { background: #334155; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; }
    .admin-nav button.active { background: #3b82f6; }

    .section { display: none; background: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .section.active { display: block; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; border: 2px solid #e2e8f0; }
    .stat-number { font-size: 2.5rem; font-weight: bold; color: #3b82f6; }
    .stat-label { color: #64748b; margin-top: 0.5rem; }

    table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; font-size: 0.9rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; font-weight: 600; }

    .import-area { border: 2px dashed #cbd5e1; padding: 2rem; text-align: center; border-radius: 0.5rem; margin: 1rem 0; }
    .progress-bar { width: 100%; height: 20px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 0.5rem; }
    .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }

    input[type="text"], input[type="file"], input[type="url"], input[type="password"] { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.375rem; margin: 0.5rem 0; }
    .card { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }

    .candidate-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
    .photo-preview { max-width: 200px; max-height: 200px; border-radius: 0.5rem; margin: 0.5rem 0; }

    .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .monitor-card { background: white; border: 2px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; }
    .monitor-card.voted { border-color: #10b981; background: #f0fdf4; }
    .monitor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .monitor-title { font-weight: bold; color: #1e293b; }
    .monitor-stats { display: flex; gap: 1rem; font-size: 0.875rem; color: #64748b; }

    .live-indicator { display: inline-flex; align-items: center; gap: 0.5rem; color: #10b981; font-size: 0.875rem; margin-bottom: 1rem; }
    .live-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .winner-card { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 0.75rem; padding: 1.5rem; text-align: center; margin: 1rem 0; }
    .winner-trophy { font-size: 3rem; margin-bottom: 0.5rem; }
    .results-closed { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .results-open { background: #dcfce7; border: 2px solid #22c55e; color: #166534; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }

    .grade-section { margin-bottom: 1.5rem; }
    .grade-title { font-size: 1.25rem; font-weight: bold; color: #1e40af; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }

    .refresh-btn { background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; margin-bottom: 1rem; }
    .refresh-btn:hover { background: #2563eb; }
    .last-update { color: #64748b; font-size: 0.875rem; margin-top: 0.5rem; }

    .small-note { font-size: 0.85rem; color: #64748b; margin-top: 0.5rem; }

    .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .action-btn { padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .action-btn:hover { transform: translateY(-1px); }

    /* Estilos para impresi√≥n de resultados */
    .print-area { display: none; }
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }

    /* Estilos para carnets */
    .carnet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 1rem; }
    .carnet { border: 2px solid #1e293b; border-radius: 0.5rem; padding: 12px; background: white; page-break-inside: avoid; }
    .carnet-header { display: flex; align-items: center; gap: 0.75rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
    .carnet-logo { width: 60px; height: 60px; border-radius: 50%; object-fit: contain; padding: 5px; background: #fff; border: 1px solid #e2e8f0; }
    .carnet-title { font-weight: bold; color: #1e293b; font-size: 0.9rem; }
    .carnet-subtitle { font-size: 0.8rem; color: #64748b; }
    .carnet-info { font-size: 0.85rem; }
    .carnet-code { font-family: monospace; font-size: 1.25rem; font-weight: bold; color: #3b82f6; text-align: center; padding: 0.5rem; background: #f1f5f9; border-radius: 0.375rem; margin-top: 0.5rem; }
    .carnet-qr-container { display: flex; justify-content: center; margin: 0.75rem 0; }
    .carnet-qr-container img { border: 2px solid #e2e8f0; border-radius: 0.375rem; max-width: 120px; height: auto; }
    .carnet-qr-container canvas { border: 2px solid #e2e8f0; border-radius: 0.375rem; max-width: 120px; height: auto; }
    .carnet-footer { font-size: 0.7rem; color: #94a3b8; text-align: center; margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px dashed #e2e8f0; }

    /* √Årea de filtros para carnets */
    .filter-area { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 0.5rem; }
    .filter-group label { font-size: 0.875rem; font-weight: 600; }
    .filter-group select { padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 0.375rem; }

    /* Modal overlay */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 0.75rem; padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; }
    .modal-header h3 { font-size: 1.5rem; color: #1e293b; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; transition: all 0.2s; }
    .modal-close:hover { background: #f1f5f9; color: #1e293b; }
    .modal-body { margin-bottom: 1.5rem; }
    .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 2px solid #e2e8f0; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1e293b; font-size: 0.9rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.375rem; font-size: 1rem; transition: border-color 0.2s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; }
    .form-group small { display: block; margin-top: 0.25rem; color: #64748b; font-size: 0.85rem; }
    .code-preview { background: #f1f5f9; padding: 1rem; border-radius: 0.5rem; text-align: center; margin-top: 1rem; border: 2px dashed #cbd5e1; }
    .code-preview-label { font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem; }
    .code-preview-value { font-family: monospace; font-size: 1.75rem; font-weight: bold; color: #3b82f6; letter-spacing: 0.1em; }

    /* Bot√≥n flotante para agregar estudiante */
    .floating-add-btn { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 50%; font-size: 1.75rem; cursor: pointer; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); transition: all 0.3s; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .floating-add-btn:hover { transform: scale(1.1); box-shadow: 0 15px 35px rgba(59, 130, 246, 0.5); }
    .floating-add-btn:active { transform: scale(0.95); }

    /* Modal styles */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; padding: 2rem; border-radius: 0.75rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .modal-close:hover { color: #1e293b; }

    /* Toast notifications */
    .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; z-index: 3000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.warning { background: #f59e0b; }
    .toast.info { background: #3b82f6; }

    /* Estilos para carga de archivos */
    .file-upload-area { border: 2px dashed #cbd5e1; padding: 1.5rem; text-align: center; border-radius: 0.5rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.2s; }
    .file-upload-area:hover { border-color: #3b82f6; background: #f8fafc; }
    .file-upload-area.dragover { border-color: #3b82f6; background: #dbeafe; }
    .file-upload-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .file-upload-text { color: #64748b; font-size: 0.875rem; }
    .image-preview-container { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; }
    .image-preview-container img { max-width: 150px; max-height: 150px; border-radius: 0.5rem; object-fit: cover; }
    .image-info { font-size: 0.875rem; color: #64748b; }
    .remove-image-btn { background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; }
    .file-requirements { font-size: 0.8rem; color: #64748b; margin-top: 0.5rem; }
    .file-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; }
  </style>
</head>

<body>
  <div id="login-overlay" class="login-overlay">
    <div class="login-box">
      <h2>üîê Acceso Administrativo</h2>
      <p>Ingresa el c√≥digo de administrador</p>
      <input type="password" id="admin-code" placeholder="C√≥digo admin" autocomplete="off">
      <button onclick="login()" class="btn btn-primary" style="width: 100%;">Ingresar</button>
      <p class="small-note" id="api-debug"></p>
      <p id="login-error" style="color: #ef4444; margin-top: 1rem;"></p>
    </div>
  </div>

  <div class="container" id="admin-container" style="display:none;">
    <div class="header">
      <h1>‚öôÔ∏è Panel de Administraci√≥n</h1>
      <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem; flex-wrap:wrap;">
        <span id="election-status">Estado: Cerrada</span>
        <button id="btn-toggle" class="btn btn-primary" onclick="toggleElection()">Abrir Votaci√≥n</button>
      </div>
    </div>

    <nav class="admin-nav" id="admin-nav">
      <button data-sec="dashboard" class="active">Dashboard</button>
      <button data-sec="monitor">Monitoreo</button>
      <button data-sec="results">Resultados</button>
      <button data-sec="school">Colegio</button>
      <button data-sec="candidates">Candidatos</button>
      <button data-sec="students">Estudiantes</button>
      <button data-sec="carnets">Carnets</button>
      <button data-sec="qrcodes">C√≥digos QR</button>
      <button data-sec="import">Importar Excel</button>
    </nav>

    <section id="sec-dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="stat-total">0</div><div class="stat-label">Total Estudiantes</div></div>
        <div class="stat-card"><div class="stat-number" id="stat-voted">0</div><div class="stat-label">Han Votado</div></div>
        <div class="stat-card"><div class="stat-number" id="stat-participation">0%</div><div class="stat-label">Participaci√≥n</div></div>
        <div class="stat-card"><div class="stat-number" id="stat-candidates">0</div><div class="stat-label">Candidatos</div></div>
      </div>
      <h3>Participaci√≥n por Grado</h3>
      <div id="grade-stats"></div>
    </section>

    <section id="sec-monitor" class="section">
      <div class="live-indicator"><span class="live-dot"></span><span>Monitoreo en tiempo real</span></div>
      <button onclick="loadMonitorData()" class="refresh-btn">üîÑ Actualizar ahora</button>
      <div class="last-update" id="monitor-last-update"></div>

      <div class="card" style="margin-top: 1rem;">
        <h3>Resumen General</h3>
        <div id="monitor-summary" style="margin-top: 1rem;"></div>
      </div>

      <h3 style="margin-top: 1.5rem;">Detalle por Grado y Curso</h3>
      <div id="monitor-courses" style="margin-top: 1rem;"></div>

      <h3 style="margin-top: 1.5rem;">Por Grado (Consolidado)</h3>
      <div id="monitor-grades" style="margin-top: 1rem;"></div>
    </section>

    <section id="sec-results" class="section">
      <div class="action-buttons">
        <button onclick="loadFinalResults()" class="action-btn btn-secondary">üîÑ Actualizar Resultados</button>
        <button onclick="printResults()" class="action-btn btn-primary">üñ®Ô∏è Imprimir Acta</button>
        <button onclick="exportResultsPDF()" class="action-btn btn-info">üìÑ Exportar PDF</button>
      </div>
      
      <div id="results-status"></div>
      <div id="final-results-content"></div>
      
      <!-- √Årea de impresi√≥n oculta -->
      <div id="print-area" class="print-area"></div>
    </section>

    <section id="sec-school" class="section">
      <h2>Configuraci√≥n del Colegio</h2>
      <div class="card">
        <h3>Escudo y Nombre del Colegio</h3>
        <p style="margin-bottom: 1rem; color: #64748b;">Estos datos aparecer√°n en los carnets y en la p√°gina de votaci√≥n.</p>

        <label>Nombre del Colegio:</label>
        <input type="text" id="school-name" placeholder="Ej: Colegio San Jos√©">

        <label>Escudo del Colegio:</label>
        <div class="file-upload-area" id="school-logo-upload-area" onclick="document.getElementById('school-logo-file').click()">
          <div class="file-upload-icon">üñºÔ∏è</div>
          <div class="file-upload-text">Haz clic aqu√≠ para seleccionar una imagen</div>
          <div class="file-requirements">Formatos permitidos: JPG, PNG, GIF, WebP. M√°ximo 500KB.</div>
        </div>
        <input type="file" id="school-logo-file" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handleImageUpload(this, 'school-logo-preview', 'school-logo-data')">
        <div id="school-logo-error" class="file-error"></div>
        
        <div id="school-logo-preview" class="image-preview-container" style="display: none;">
          <img id="school-logo-img" src="" alt="Vista previa del escudo">
          <div class="image-info">
            <p><strong>Archivo seleccionado:</strong> <span id="school-logo-filename"></span></p>
            <p><strong>Tama√±o:</strong> <span id="school-logo-filesize"></span></p>
          </div>
          <button type="button" class="remove-image-btn" onclick="removeImage('school-logo-preview', 'school-logo-data')">‚úï Quitar</button>
        </div>
        
        <!-- Campo oculto para almacenar imagen Base64 -->
        <input type="hidden" id="school-logo-data" value="">
        
        <!-- Campo oculto para compatibilidad con URLs existentes -->
        <input type="hidden" id="school-logo-url-legacy" placeholder="https://...">

        <div id="logo-preview"></div>
        <button onclick="saveSchoolConfig()" class="btn btn-primary" style="width:auto; margin-top:1rem;">Guardar Configuraci√≥n</button>
      </div>
    </section>

    <section id="sec-candidates" class="section">
      <h2>Gesti√≥n de Candidatos</h2>
      <div class="card">
        <h3>Agregar Candidato</h3>
        <input type="text" id="new-candidate-name" placeholder="Nombre completo">
        <input type="text" id="new-candidate-party" placeholder="Partido/Lista (opcional)">

        <label>Foto del candidato:</label>
        <div class="file-upload-area" id="candidate-photo-upload-area" onclick="document.getElementById('new-candidate-photo-file').click()">
          <div class="file-upload-icon">üì∑</div>
          <div class="file-upload-text">Haz clic aqu√≠ para seleccionar una foto</div>
          <div class="file-requirements">Formatos permitidos: JPG, PNG, GIF, WebP. M√°ximo 500KB.</div>
        </div>
        <input type="file" id="new-candidate-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handleImageUpload(this, 'new-candidate-photo-preview', 'new-candidate-photo-data')">
        <div id="new-candidate-photo-error" class="file-error"></div>
        
        <div id="new-candidate-photo-preview" class="image-preview-container" style="display: none;">
          <img id="new-candidate-photo-img" src="" alt="Vista previa de la foto">
          <div class="image-info">
            <p><strong>Archivo seleccionado:</strong> <span id="new-candidate-photo-filename"></span></p>
            <p><strong>Tama√±o:</strong> <span id="new-candidate-photo-filesize"></span></p>
          </div>
          <button type="button" class="remove-image-btn" onclick="removeImage('new-candidate-photo-preview', 'new-candidate-photo-data')">‚úï Quitar</button>
        </div>
        
        <!-- Campo oculto para compatibilidad -->
        <input type="hidden" id="new-candidate-photo-data" value="">
        <input type="hidden" id="new-candidate-photo-url-legacy" value="">

        <button onclick="addCandidate()" class="btn btn-primary" style="width:auto;">Agregar Candidato</button>
      </div>
      <div id="candidates-list-admin"></div>
    </section>

    <section id="sec-students" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap:wrap; gap:0.5rem;">
        <h2>Gesti√≥n de Estudiantes</h2>
        <div>
          <button onclick="resetElectionVotes()" class="action-btn btn-warning" title="Restablece los votos sin borrar estudiantes">üîÑ Restablecer Votaci√≥n</button>
          <button onclick="resetCodes()" class="action-btn btn-secondary">Regenerar C√≥digos</button>
          <button onclick="clearStudents()" class="action-btn btn-danger" title="Elimina solo los estudiantes">üóëÔ∏è Eliminar Estudiantes</button>
        </div>
      </div>

      <!-- Estad√≠sticas de participaci√≥n por curso -->
      <div id="course-stats-container" style="margin-bottom: 1.5rem;"></div>

      <!-- Filtros avanzados -->
      <div class="card" style="background: #f8fafc; padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: #1e293b;">üîç Filtros</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Estado de Voto:</label>
            <select id="filter-vote-status" onchange="applyStudentFilters()" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 0.375rem;">
              <option value="all">üìã Todos</option>
              <option value="voted">‚úÖ Han votado</option>
              <option value="pending">‚è≥ No han votado</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Grado:</label>
            <select id="filter-student-grade" onchange="applyStudentFilters()" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 0.375rem;">
              <option value="all">Todos los grados</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Curso:</label>
            <select id="filter-student-course" onchange="applyStudentFilters()" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 0.375rem;">
              <option value="all">Todos los cursos</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Buscar por nombre:</label>
            <input type="text" id="filter-student-name" placeholder="Escribe un nombre..." oninput="applyStudentFilters()" style="width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 0.375rem;">
          </div>
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button onclick="clearStudentFilters()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üîÑ Limpiar filtros</button>
          <button onclick="exportFilteredStudents()" class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üì• Exportar filtrados a Excel</button>
          <button onclick="printFilteredCarnets()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üñ®Ô∏è Imprimir carnets filtrados</button>
          <button onclick="copyFilteredCodes()" class="btn btn-info" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üìã Copiar c√≥digos</button>
        </div>
      </div>

      <!-- Contador de resultados filtrados -->
      <div id="filter-counter" style="margin: 1rem 0; padding: 0.75rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 0.375rem; font-weight: 600; color: #1e40af;">
        Mostrando todos los estudiantes
      </div>

      <div id="students-table-container"></div>

      <!-- Bot√≥n flotante para agregar estudiante (solo visible en esta secci√≥n) -->
      <button id="floating-add-student-btn" class="floating-add-btn" onclick="openAddStudentModal()" style="display: none;" title="Agregar estudiante">
        ‚ûï
      </button>
    </section>

    <!-- Modal para agregar estudiante manualmente -->
    <div id="add-student-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>‚ûï Agregar Estudiante</h3>
          <button class="modal-close" onclick="closeAddStudentModal()">‚úï</button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label>Nombre completo: *</label>
            <input type="text" id="new-student-name" placeholder="Ej: Juan P√©rez Garc√≠a" />
            <small>Ingresa el nombre completo del estudiante</small>
          </div>

          <div class="form-group">
            <label>Grado: *</label>
            <select id="new-student-grade" onchange="updateCodePreview()">
              <option value="">Selecciona un grado</option>
              <option value="0">0¬∞ (Transici√≥n)</option>
              <option value="1">1¬∞</option>
              <option value="2">2¬∞</option>
              <option value="3">3¬∞</option>
              <option value="4">4¬∞</option>
              <option value="5">5¬∞</option>
              <option value="6">6¬∞</option>
              <option value="7">7¬∞</option>
              <option value="8">8¬∞</option>
              <option value="9">9¬∞</option>
              <option value="10">10¬∞</option>
              <option value="11">11¬∞</option>
              <option value="12">12¬∞</option>
            </select>
          </div>

          <div class="form-group">
            <label>Curso: *</label>
            <select id="new-student-course" onchange="updateCodePreview()">
              <option value="">Selecciona un curso</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
            </select>
          </div>

          <div class="form-group">
            <label>N√∫mero de lista: *</label>
            <select id="new-student-list-mode" onchange="toggleListInput()">
              <option value="auto">Autoasignar (siguiente disponible)</option>
              <option value="manual">Ingresar manualmente</option>
            </select>
            <input type="number" id="new-student-list" min="1" max="99" placeholder="1-99" style="margin-top: 0.5rem; display: none;" onchange="updateCodePreview()" />
            <small>El n√∫mero de lista se usar√° para generar el c√≥digo √∫nico</small>
          </div>

          <div class="code-preview">
            <div class="code-preview-label">C√≥digo que se generar√°:</div>
            <div class="code-preview-value" id="code-preview-display">-----</div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeAddStudentModal()">Cancelar</button>
          <button class="btn btn-success" onclick="addStudentManually()">‚úÖ Agregar Estudiante</button>
        </div>
      </div>
    </div>

    <section id="sec-carnets" class="section">
      <h2>üé¥ Generador de Carnets Electorales</h2>
      <p style="margin-bottom: 1rem; color: #64748b;">
        Genera carnets electorales para imprimir. Cada carnet incluye el <strong>c√≥digo num√©rico</strong> y un <strong>c√≥digo QR</strong> 
        para que el estudiante pueda votar de la forma que prefiera.
      </p>
      
      <div class="card" style="background:#ecfdf5; border-left:4px solid #10b981; margin-bottom:1rem;">
        <h4>‚ú® Carnets con doble opci√≥n</h4>
        <ul style="margin-left:1.5rem; margin-top:0.5rem;">
          <li><strong>C√≥digo num√©rico:</strong> El estudiante puede ingresar manualmente su c√≥digo de 5 d√≠gitos</li>
          <li><strong>C√≥digo QR:</strong> El estudiante puede escanear el QR con su celular para votar autom√°ticamente</li>
          <li>Ambas opciones est√°n en el mismo carnet - ¬°el estudiante elige!</li>
        </ul>
      </div>
      
      <div class="filter-area">
        <div class="filter-group">
          <label>Grado:</label>
          <select id="filter-grade" onchange="loadStudentsForCarnets()">
            <option value="all">Todos los grados</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Curso:</label>
          <select id="filter-course" onchange="loadStudentsForCarnets()">
            <option value="all">Todos los cursos</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Estado:</label>
          <select id="filter-status" onchange="loadStudentsForCarnets()">
            <option value="all">Todos</option>
            <option value="pending">Pendientes de votar</option>
            <option value="voted">Ya voteron</option>
          </select>
        </div>
      </div>

      <div class="action-buttons">
        <button onclick="loadStudentsForCarnets()" class="action-btn btn-secondary">üîÑ Actualizar Lista</button>
        <button onclick="printCarnets()" class="action-btn btn-primary">üñ®Ô∏è Imprimir Carnets</button>
        <button onclick="exportCarnetsPDF()" class="action-btn btn-info">üìÑ Exportar PDF</button>
        <button onclick="selectAllCarnets()" class="action-btn btn-success">‚úÖ Seleccionar Todos</button>
        <button onclick="deselectAllCarnets()" class="action-btn btn-secondary">‚ùå Deseleccionar Todos</button>
      </div>

      <div id="carnets-container" class="carnet-grid">
        <p style="color: #64748b; text-align: center; padding: 2rem;">Cargando estudiantes...</p>
      </div>
    </section>

    <section id="sec-qrcodes" class="section">
      <h2>üì± C√≥digos QR para Votaci√≥n</h2>
      
      <div class="card" style="background:#ecfdf5; border-left:4px solid #10b981;">
        <h4>‚úÖ ¬°Los carnets ya incluyen c√≥digos QR!</h4>
        <p style="margin-top:0.5rem;">
          Los <strong>Carnets Electorales</strong> (secci√≥n anterior) ya incluyen autom√°ticamente el c√≥digo QR de cada estudiante.
          <strong>No necesitas generar c√≥digos QR por separado</strong> - solo imprime los carnets.
        </p>
      </div>

      <div class="card" style="background:#fffbeb; border-left:4px solid #f59e0b; margin-top:1rem;">
        <h4>ü§î ¬øCu√°ndo usar esta secci√≥n?</h4>
        <p style="margin-top:0.5rem;">
          Esta p√°gina de c√≥digos QR independientes es <strong>opcional</strong> y solo √∫til si:
        </p>
        <ul style="margin-left:1.5rem; margin-top:0.5rem;">
          <li>Quieres distribuir c√≥digos QR digitalmente (sin imprimir carnets)</li>
          <li>Necesitas c√≥digos QR m√°s grandes para imprimir separado</li>
          <li>Quieres solo el QR sin el carnet completo</li>
        </ul>
        <p style="margin-top:0.5rem;">
          <strong>Para uso normal:</strong> Ve a la secci√≥n "Carnets" que ya incluye todo lo que necesitas.
        </p>
      </div>
      
      <div class="action-buttons" style="margin-top:1rem;">
        <button onclick="window.location.hash = '#carnets'; showSection('carnets', document.querySelector('[data-sec=carnets]'))" class="action-btn btn-success" style="font-size:1rem; padding:0.75rem 1.5rem;">
          üé¥ Ir a Generar Carnets (Recomendado)
        </button>
        <button onclick="window.open('generar-qr.html', '_blank')" class="action-btn btn-secondary">
          üì± Abrir Generador QR Independiente (Opcional)
        </button>
      </div>

      <div class="card" style="background:#dbeafe; border-left:4px solid #3b82f6; margin-top:1rem;">
        <h4>üí° ¬øC√≥mo funcionan los c√≥digos QR?</h4>
        <ul style="margin-left:1.5rem; margin-top:0.5rem;">
          <li>Cada c√≥digo QR contiene el c√≥digo √∫nico del estudiante</li>
          <li>El estudiante escanea el QR con su celular</li>
          <li>Se abre autom√°ticamente la p√°gina de votaci√≥n con su c√≥digo pre-cargado</li>
          <li>Solo debe confirmar su identidad y seleccionar su candidato</li>
          <li><strong>Tambi√©n puede ingresar el c√≥digo manualmente si lo prefiere</strong></li>
        </ul>
      </div>

      <div class="card" style="margin-top:1rem;">
        <h4>üîß Opciones de votaci√≥n para estudiantes</h4>
        <p style="color:#64748b; margin-bottom:0.75rem;">
          En la p√°gina de votaci√≥n, los estudiantes tienen estas opciones:
        </p>
        <ul style="margin-left:1.5rem;">
          <li><strong>Escanear QR del carnet:</strong> Con la c√°mara del celular, abre directamente la p√°gina</li>
          <li><strong>Bot√≥n "Escanear QR":</strong> Usar la c√°mara del dispositivo para escanear el QR</li>
          <li><strong>Ingresar c√≥digo manualmente:</strong> Escribir el c√≥digo de 5 d√≠gitos</li>
        </ul>
        <p style="margin-top:0.75rem; padding:0.75rem; background:#f8fafc; border-radius:0.5rem; font-size:0.9rem;">
          <strong>üí° Tip:</strong> Los carnets incluyen ambas opciones (c√≥digo num√©rico y QR) para m√°xima flexibilidad.
        </p>
      </div>
    </section>

    <section id="sec-import" class="section">
      <h2>Importar desde Excel</h2>

      <div class="card" style="background:#dbeafe; border-left:4px solid #3b82f6;">
        <h4>üìã Instrucciones</h4>
        <ul style="margin-left:1.5rem; margin-top:0.5rem;">
          <li>El archivo puede ser <strong>.xlsx, .xls o .csv</strong></li>
          <li>La primera fila debe tener los t√≠tulos de columnas</li>
          <li>Columnas reconocidas: <strong>Nombre, Grado, Curso</strong></li>
          <li>Los c√≥digos se generan: <strong>GGCLL</strong> (ej: 06105)</li>
        </ul>
      </div>

      <div class="card">
        <h3>Seleccionar Archivo</h3>
        <div class="import-area">
          <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="display:none;">
          <button onclick="document.getElementById('excel-file').click()" class="btn btn-primary" style="width:auto;">üìÅ Seleccionar Archivo Excel</button>
          <p style="margin-top:1rem; color:#64748b;" id="file-name">Ning√∫n archivo seleccionado</p>
        </div>

        <div id="import-preview"></div>
        <button id="btn-import" onclick="importStudents()" class="btn btn-success" style="display:none; width:100%; margin-top:1rem;">‚úÖ Importar Estudiantes</button>
        <div id="import-result"></div>
      </div>
    </section>
  </div>

  <!-- √Årea de impresi√≥n de carnets -->
  <div id="carnets-print-area" class="print-area"></div>

  <!-- Modal para editar foto de candidato -->
  <div id="edit-photo-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Editar Foto del Candidato</h3>
        <button class="modal-close" onclick="closeEditPhotoModal()">&times;</button>
      </div>
      <div id="edit-photo-content">
        <div class="file-upload-area" id="edit-candidate-photo-upload-area" onclick="document.getElementById('edit-candidate-photo-file').click()">
          <div class="file-upload-icon">üì∑</div>
          <div class="file-upload-text">Haz clic aqu√≠ para seleccionar una nueva foto</div>
          <div class="file-requirements">Formatos permitidos: JPG, PNG, GIF, WebP. M√°ximo 500KB.</div>
        </div>
        <input type="file" id="edit-candidate-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handleImageUpload(this, 'edit-candidate-photo-preview', 'edit-candidate-photo-data', 'edit-photo-error')">
        <div id="edit-photo-error" class="file-error"></div>
        
        <div id="edit-candidate-photo-preview" class="image-preview-container" style="display: none;">
          <img id="edit-candidate-photo-img" src="" alt="Vista previa de la foto">
          <div class="image-info">
            <p><strong>Archivo seleccionado:</strong> <span id="edit-candidate-photo-filename"></span></p>
            <p><strong>Tama√±o:</strong> <span id="edit-candidate-photo-filesize"></span></p>
          </div>
          <button type="button" class="remove-image-btn" onclick="removeImage('edit-candidate-photo-preview', 'edit-candidate-photo-data')">‚úï Quitar</button>
        </div>
        
        <input type="hidden" id="edit-candidate-photo-data" value="">
        <input type="hidden" id="edit-candidate-id" value="">
        
        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button onclick="closeEditPhotoModal()" class="btn btn-secondary">Cancelar</button>
          <button onclick="saveCandidatePhoto()" class="btn btn-primary">Guardar Foto</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container"></div>

  <script>
    // ‚úÖ API absoluta (evita fallos por rutas relativas)
    const API_URL = `${location.origin}/api`;

    let adminCode = localStorage.getItem('admin_code') || '';
    let excelData = [];
    let schoolConfig = {};
    let monitorInterval = null;
    let allStudentsForCarnets = [];

    // Debug visible para que veas a qu√© API est√° pegando
    document.getElementById('api-debug').textContent = `API: ${API_URL}`;

    if (adminCode) document.getElementById('admin-code').value = adminCode;

    // NAV
    document.getElementById('admin-nav').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-sec]');
      if (!btn) return;
      showSection(btn.getAttribute('data-sec'), btn);
    });

    // ========== FUNCIONES DE CARGA DE IM√ÅGENES ==========
    
    /**
     * Valida que el archivo sea una imagen y no supere 500KB
     */
    function validateImageFile(file) {
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      const maxSize = 500 * 1024; // 500KB en bytes

      if (!allowedTypes.includes(file.type)) {
        return { valid: false, error: 'Tipo de archivo no permitido. Solo se aceptan JPG, PNG, GIF y WebP.' };
      }

      if (file.size > maxSize) {
        return { valid: false, error: `El archivo es muy grande (${formatFileSize(file.size)}). M√°ximo permitido: 500KB.` };
      }

      return { valid: true };
    }

    /**
     * Formatea el tama√±o del archivo para mostrarlo
     */
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    /**
     * Maneja la carga de un archivo de imagen
     */
    function handleImageUpload(input, previewContainerId, dataFieldId, errorFieldId = null) {
      const file = input.files[0];
      if (!file) return;

      // Validar el archivo
      const validation = validateImageFile(file);
      if (!validation.valid) {
        if (errorFieldId) {
          document.getElementById(errorFieldId).textContent = validation.error;
        }
        input.value = ''; // Limpiar el input
        showToast(validation.error, 'error');
        return;
      }

      // Limpiar mensaje de error si existe
      if (errorFieldId) {
        document.getElementById(errorFieldId).textContent = '';
      }

      // Convertir a Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result;
        
        // Guardar en campo oculto
        document.getElementById(dataFieldId).value = base64Data;

        // Mostrar previsualizaci√≥n
        const previewContainer = document.getElementById(previewContainerId);
        const previewImg = previewContainer.querySelector('img');
        const filenameSpan = document.getElementById(previewContainerId.replace('-preview', '-filename'));
        const filesizeSpan = document.getElementById(previewContainerId.replace('-preview', '-filesize'));

        previewImg.src = base64Data;
        filenameSpan.textContent = file.name;
        filesizeSpan.textContent = formatFileSize(file.size);
        previewContainer.style.display = 'flex';

        // Limpiar el input de archivo para evitar confusi√≥n
        input.value = '';

        showToast('Imagen cargada correctamente', 'success');
      };

      reader.onerror = function() {
        showToast('Error al leer el archivo', 'error');
      };

      reader.readAsDataURL(file);
    }

    /**
     * Elimina una imagen cargada
     */
    function removeImage(previewContainerId, dataFieldId) {
      document.getElementById(previewContainerId).style.display = 'none';
      document.getElementById(dataFieldId).value = '';
      showToast('Imagen eliminada', 'info');
    }

    /**
     * Maneja el cambio de URL del logo (compatibilidad hacia atr√°s)
     */
    // Funci√≥n deshabilitada - ya no se permite cargar escudo por URL
    /*
    function handleLogoUrlChange(url) {
      if (url && url.startsWith('http')) {
        // Limpiar datos de archivo si hay URL
        document.getElementById('school-logo-data')?.remove();
        document.getElementById('school-logo-preview').style.display = 'none';
        
        // Mostrar preview de la URL
        const preview = document.getElementById('logo-preview');
        preview.innerHTML = `<p>Vista previa:</p><img src="${url}" class="photo-preview" onerror="this.style.display='none'" onload="this.style.display='block'">`;
      }
    }
    */

    /**
     * Genera un avatar con iniciales para mostrar cuando no hay imagen
     */
    function generateInitialsAvatar(name, size = 60) {
      const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
      const color = colors[name.charCodeAt(0) % colors.length];
      
      return `data:image/svg+xml,${encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
          <rect width="100%" height="100%" fill="${color}" rx="${size/2}"/>
          <text x="50%" y="50%" text-anchor="middle" dy="0.35" fill="white" font-family="Arial" font-size="${size/2.5}" font-weight="bold">${initials}</text>
        </svg>
      `)}`;
    }

    // ========== FIN FUNCIONES DE CARGA DE IM√ÅGENES ==========

    // ‚úÖ LOGIN MEJORADO: muestra el error real
    async function login() {
      const code = document.getElementById('admin-code').value.trim();
      const errorDiv = document.getElementById('login-error');
      errorDiv.textContent = '';

      if (!code) {
        errorDiv.textContent = 'Ingresa el c√≥digo';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/admin/students`, {
          method: 'GET',
          headers: {
            'x-admin-code': code
          }
        });

        if (res.status === 404) {
          errorDiv.textContent = 'ERROR: /api/admin/login no existe (404). Revisa el backend api/[...path].js';
          return;
        }

        if (res.status === 401) {
          errorDiv.textContent = 'C√≥digo incorrecto (401)';
          return;
        }

        if (!res.ok) {
          const txt = await res.text();
          errorDiv.textContent = `Error (${res.status}): ${txt}`;
          return;
        }

        adminCode = code;
        localStorage.setItem('admin_code', code);

        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('admin-container').style.display = 'block';

        await loadSchoolConfig();
        await loadDashboard();
        await refreshElectionStatusUI();
      } catch (err) {
        errorDiv.textContent = 'Error de conexi√≥n: ' + err.message;
      }
    }

    function showSection(section, clickedButton) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));

      document.getElementById(`sec-${section}`).classList.add('active');
      if (clickedButton) clickedButton.classList.add('active');

      if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
      }

      if (section === 'dashboard') loadDashboard();
      if (section === 'monitor') {
        loadMonitorData();
        monitorInterval = setInterval(loadMonitorData, 10000);
      }
      if (section === 'results') loadFinalResults();
      if (section === 'students') loadStudents();
      if (section === 'candidates') loadCandidates();
      if (section === 'school') loadSchoolConfig();
      if (section === 'carnets') initCarnetsSection();

      // Mostrar/ocultar bot√≥n flotante
      toggleFloatingButton(section);
    }

    // ========== TOAST NOTIFICATIONS ==========
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function refreshElectionStatusUI() {
      try {
        const res = await fetch(`${API_URL}/check-status`);
        const data = await res.json();
        updateElectionButton(!!data.open);
      } catch {}
    }

    async function loadSchoolConfig() {
      try {
        const res = await fetch(`${API_URL}/config`);
        const data = await res.json();
        schoolConfig = data;
        document.getElementById('school-name').value = data.school_name || '';
        
        // Mostrar vista previa del logo guardado
        const logoUrl = data.school_logo_url || '';
        if (logoUrl) {
          // Guardar en campo oculto para compatibilidad
          document.getElementById('school-logo-url-legacy').value = logoUrl;
          
          // Mostrar vista previa del escudo guardado
          const previewDiv = document.getElementById('logo-preview');
          previewDiv.innerHTML = `
            <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 2px solid #e2e8f0;">
              <p style="margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">üì∏ Escudo actual del colegio:</p>
              <img src="${logoUrl}" class="photo-preview" onerror="this.style.display='none'" onload="this.style.display='block'" style="max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 2px solid #e2e8f0;">
              <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">Para cambiar el escudo, selecciona una nueva imagen arriba.</p>
            </div>
          `;
        } else {
          document.getElementById('logo-preview').innerHTML = `
            <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem; border: 2px solid #f59e0b;">
              <p style="color: #92400e; font-size: 0.9rem;">‚ö†Ô∏è A√∫n no has cargado un escudo para el colegio.</p>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error cargando config:', err);
      }
    }

    async function saveSchoolConfig() {
      const name = document.getElementById('school-name').value.trim();
      
      // Solo usar datos de archivo Base64 (ya no se permite URL)
      const logoData = document.getElementById('school-logo-data')?.value || '';

      try {
        const res = await fetch(`${API_URL}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ school_name: name, school_logo_url: logoData, admin_code: adminCode })
        });

        if (res.ok) {
          showToast('Configuraci√≥n guardada correctamente', 'success');
          schoolConfig = { school_name: name, school_logo_url: logoData };
          
          // Limpiar el √°rea de carga
          if (logoData) {
            removeImage('school-logo-preview', 'school-logo-data');
          }
          
          // Recargar la configuraci√≥n para mostrar la vista previa actualizada
          await loadSchoolConfig();
        } else {
          showToast('Error al guardar configuraci√≥n', 'error');
        }
      } catch (err) {
        showToast('Error de conexi√≥n', 'error');
      }
    }

    async function loadDashboard() {
      try {
        const res = await fetch(`${API_URL}/stats`, { headers: { 'x-admin-code': adminCode } });
        if (res.status === 401) { showToast('C√≥digo admin inv√°lido', 'error'); return; }

        const data = await res.json();
        document.getElementById('stat-total').textContent = data.general.totalStudents;
        document.getElementById('stat-voted').textContent = data.general.totalVoted;
        document.getElementById('stat-participation').textContent = data.general.participation + '%';
        document.getElementById('stat-candidates').textContent = data.results?.length || 0;

        const gradeContainer = document.getElementById('grade-stats');
        gradeContainer.innerHTML = (data.byGrade || []).map(g => `
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
              <span>Grado ${g.grade}¬∞</span>
              <span>${g.voted}/${g.total_students} (${g.participation_percent}%)</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:${g.participation_percent}%"></div></div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error dashboard:', err);
      }
    }

    async function loadMonitorData() {
      try {
        const res = await fetch(`${API_URL}/monitor`, { headers: { 'x-admin-code': adminCode } });
        if (res.status === 401) { showToast('C√≥digo admin inv√°lido', 'error'); return; }

        const data = await res.json();
        document.getElementById('monitor-last-update').textContent = `√öltima actualizaci√≥n: ${data.lastUpdate}`;

        const summary = data.summary || { total:0, voted:0, pending:0, participation:0 };
        document.getElementById('monitor-summary').innerHTML = `
          <div class="stats-grid" style="margin-bottom:0;">
            <div class="stat-card"><div class="stat-number">${summary.total}</div><div class="stat-label">Total Estudiantes</div></div>
            <div class="stat-card" style="border-color:#10b981;"><div class="stat-number" style="color:#10b981;">${summary.voted}</div><div class="stat-label">Han Votado ‚úì</div></div>
            <div class="stat-card" style="border-color:#f59e0b;"><div class="stat-number" style="color:#f59e0b;">${summary.pending}</div><div class="stat-label">Pendientes</div></div>
            <div class="stat-card" style="border-color:#3b82f6;"><div class="stat-number">${summary.participation}%</div><div class="stat-label">Participaci√≥n</div></div>
          </div>
        `;

        const coursesByGrade = {};
        (data.courses || []).forEach(c => {
          if (!coursesByGrade[c.grade]) coursesByGrade[c.grade] = [];
          coursesByGrade[c.grade].push(c);
        });

        let coursesHTML = '';
        for (const [grade, courses] of Object.entries(coursesByGrade).sort((a,b)=>a[0]-b[0])) {
          coursesHTML += `
            <div class="grade-section">
              <div class="grade-title">Grado ${grade}¬∞</div>
              <div class="monitor-grid">
                ${courses.map(c => `
                  <div class="monitor-card ${c.voted > 0 ? 'voted' : ''}">
                    <div class="monitor-header">
                      <span class="monitor-title">Curso ${c.course}</span>
                      <span style="font-weight:bold;">${c.participation}%</span>
                    </div>
                    <div class="monitor-stats">
                      <span>‚úì ${c.voted} votaron</span>
                      <span>‚óã ${c.pending} pendientes</span>
                      <span>Total: ${c.total}</span>
                    </div>
                    <div class="progress-bar" style="margin-top:0.5rem; height:8px;">
                      <div class="progress-fill" style="width:${c.participation}%;"></div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        document.getElementById('monitor-courses').innerHTML = coursesHTML || '<p>No hay datos de cursos</p>';

        document.getElementById('monitor-grades').innerHTML = `
          <table>
            <thead>
              <tr><th>Grado</th><th>Total</th><th>Voteeron</th><th>Pendientes</th><th>Participaci√≥n</th></tr>
            </thead>
            <tbody>
              ${(data.grades || []).map(g => `
                <tr>
                  <td><strong>${g.grade}¬∞</strong></td>
                  <td>${g.total}</td>
                  <td style="color:#10b981; font-weight:600;">${g.voted}</td>
                  <td>${g.pending}</td>
                  <td><strong>${g.participation}%</strong></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Error monitoreo:', err);
        document.getElementById('monitor-courses').innerHTML = '<p style="color:#ef4444;">Error al cargar datos.</p>';
      }
    }

    async function loadFinalResults() {
      try {
        const res = await fetch(`${API_URL}/results`, { headers: { 'x-admin-code': adminCode } });
        const data = await res.json();

        const container = document.getElementById('final-results-content');
        const statusDiv = document.getElementById('results-status');

        const statusRes = await fetch(`${API_URL}/check-status`);
        const statusData = await statusRes.json();

        if (statusData.open) {
          statusDiv.innerHTML = `<div class="results-closed">‚ö†Ô∏è <strong>La votaci√≥n a√∫n est√° abierta</strong><br>Cierra la votaci√≥n desde el Dashboard para ver resultados oficiales.</div>`;
        } else {
          statusDiv.innerHTML = `<div class="results-open">‚úÖ <strong>Votaci√≥n cerrada</strong> - Resultados oficiales</div>`;
        }

        if (data.totalVotes === 0) {
          container.innerHTML = '<p style="text-align:center; padding:2rem; color:#64748b;">No hay votos registrados a√∫n.</p>';
          return;
        }

        let winnerHTML = '';
        if (data.winners && data.winners.length > 0) {
          if (data.isTie) {
            winnerHTML = `<div class="winner-card"><div class="winner-trophy">üèÜ</div><h3>¬°EMPATE!</h3><p>Ganadores con ${data.winners[0].votes} votos:</p><h2>${data.winners.map(w => w.name).join(' / ')}</h2></div>`;
          } else {
            winnerHTML = `<div class="winner-card"><div class="winner-trophy">üèÜ</div><h3>¬°GANADOR!</h3><h2>${data.winners[0].name}</h2><p style="font-size:1.25rem; margin-top:0.5rem;">${data.winners[0].votes} votos (${data.winners[0].percentage}%)</p></div>`;
          }
        }

        container.innerHTML = winnerHTML + `
          <h3>Resultados Detallados</h3>
          <table>
            <thead><tr><th>Posici√≥n</th><th>Candidato</th><th>Partido/Lista</th><th>Votos</th><th>%</th></tr></thead>
            <tbody>
              ${(data.results || []).map((r, index) => `
                <tr style="${index === 0 ? 'background:#fef3c7; font-weight:bold;' : ''}">
                  <td>${index+1}¬∞</td>
                  <td>${r.name}</td>
                  <td>${r.party || '-'}</td>
                  <td>${r.votes}</td>
                  <td><strong>${r.percentage}%</strong></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class="card" style="margin-top:2rem; text-align:center;">
            <h3>Estad√≠sticas</h3>
            <div class="stats-grid" style="margin-top:1rem;">
              <div class="stat-card"><div class="stat-number">${data.totalVotes}</div><div class="stat-label">Total Votos</div></div>
              <div class="stat-card"><div class="stat-number">${data.totalStudents}</div><div class="stat-label">Electores</div></div>
              <div class="stat-card"><div class="stat-number">${data.totalVoted}</div><div class="stat-label">Votantes</div></div>
              <div class="stat-card"><div class="stat-number">${data.participation}%</div><div class="stat-label">Participaci√≥n</div></div>
            </div>
          </div>
        `;
      } catch (err) {
        console.error('Error resultados:', err);
        document.getElementById('final-results-content').innerHTML = '<p style="color:#ef4444; text-align:center;">Error al cargar resultados.</p>';
      }
    }

    // ========== IMPRIMIR RESULTADOS ==========
    function printResults() {
      const content = document.getElementById('final-results-content').innerHTML;
      const status = document.getElementById('results-status').innerHTML;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Acta de Votaci√≥n</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; }
            h1 { text-align: center; color: #1e293b; border-bottom: 2px solid #1e293b; padding-bottom: 1rem; }
            h3 { color: #3b82f6; margin-top: 2rem; }
            table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            th, td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; }
            th { background: #f8fafc; }
            .winner { background: #fef3c7; }
            .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; }
            .stat { text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; }
            .stat-number { font-size: 1.5rem; font-weight: bold; color: #3b82f6; }
            .winner-card { background: #fef3c7; padding: 1.5rem; text-align: center; border: 2px solid #f59e0b; border-radius: 0.75rem; margin: 1rem 0; }
            .footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }
            .signature { display: flex; justify-content: space-around; margin-top: 3rem; }
            .sig-line { text-align: center; width: 200px; }
            .sig-line div { border-top: 1px solid #1e293b; padding-top: 0.5rem; margin-top: 3rem; font-size: 0.875rem; }
            @media print { body { -webkit-print-color-adjust: exact; } }
          </style>
        </head>
        <body>
          <h1>üìã ACTA DE VOTACI√ìN ESCOLAR</h1>
          ${status}
          ${content}
          <div class="footer">
            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-CO')}</p>
            <p><strong>Hora:</strong> ${new Date().toLocaleTimeString('es-CO')}</p>
            <p><strong>Instituci√≥n:</strong> ${schoolConfig.school_name || 'Colegio'}</p>
          </div>
          <div class="signature">
            <div class="sig-line"><div>Presidente de Mesa</div></div>
            <div class="sig-line"><div>Fiscal</div></div>
            <div class="sig-line"><div>Secretario</div></div>
          </div>
        
<hr>
<h3>üîê Seguridad de Terminales de Voto</h3>

<label>Nueva contrase√±a de terminal:</label><br>
<input type="text" id="votePasswordInput" placeholder="Dejar vac√≠o para desactivar">
<button onclick="saveVotePassword()">Guardar</button>
<p id="votePasswordStatus"></p>

<script>
async function saveVotePassword() {
  const password = document.getElementById('votePasswordInput').value;

  const res = await fetch('/api/admin/set-vote-password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-admin-code': localStorage.getItem('admin_code')
    },
    body: JSON.stringify({ password })
  });

  if (res.ok) {
    document.getElementById('votePasswordStatus').innerText = 'Configuraci√≥n guardada';
  } else {
    document.getElementById('votePasswordStatus').innerText = 'Error al guardar';
  }
}
</script>

</body>
        </html>
      `);
      printWindow.document.close();
      setTimeout(() => printWindow.print(), 500);
    }

    function exportResultsPDF() {
      showToast('Generando PDF...', 'info');
      printResults();
    }

    async function toggleElection() {
      const btn = document.getElementById('btn-toggle');
      const isOpen = btn.textContent.includes('Cerrar');
      const action = isOpen ? 'close' : 'open';

      try {
        const res = await fetch(`${API_URL}/admin/election`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ action, admin_code: adminCode })
        });

        if (res.ok) {
          updateElectionButton(action === 'open');
          showToast(action === 'open' ? 'Votaci√≥n abierta' : 'Votaci√≥n cerrada', 'success');
        } else {
          showToast('Error al cambiar estado', 'error');
        }
      } catch (err) {
        showToast('Error al cambiar estado', 'error');
      }
    }

    function updateElectionButton(isOpen) {
      const btn = document.getElementById('btn-toggle');
      const status = document.getElementById('election-status');

      if (isOpen) {
        btn.textContent = 'Cerrar Votaci√≥n';
        btn.className = 'btn btn-danger';
        status.textContent = 'Estado: Abierta';
        status.style.color = '#10b981';
      } else {
        btn.textContent = 'Abrir Votaci√≥n';
        btn.className = 'btn btn-primary';
        status.textContent = 'Estado: Cerrada';
        status.style.color = '#64748b';
      }
    }

    // Variable global para almacenar todos los estudiantes
    let allStudents = [];
    let filteredStudents = [];

    async function loadStudents() {
      try {
        const res = await fetch(`${API_URL}/admin/students`, { headers: { 'x-admin-code': adminCode } });
        const data = await res.json();

        allStudents = data.students || [];
        
        if (allStudents.length === 0) {
          document.getElementById('students-table-container').innerHTML = '<p>No hay estudiantes registrados</p>';
          document.getElementById('course-stats-container').innerHTML = '';
          return;
        }

        // Cargar opciones de filtros
        populateFilterOptions();
        
        // Mostrar estad√≠sticas por curso
        displayCourseStats();
        
        // Aplicar filtros (inicialmente muestra todos)
        applyStudentFilters();
        
      } catch (err) {
        console.error('Error students:', err);
      }
    }

    function populateFilterOptions() {
      // Obtener grados √∫nicos
      const grades = [...new Set(allStudents.map(s => s.grade))].sort((a, b) => a - b);
      const gradeSelect = document.getElementById('filter-student-grade');
      gradeSelect.innerHTML = '<option value="all">Todos los grados</option>';
      grades.forEach(g => {
        gradeSelect.innerHTML += `<option value="${g}">${g === 0 ? 'Transici√≥n (0¬∞)' : g + '¬∞'}</option>`;
      });

      // Obtener cursos √∫nicos
      const courses = [...new Set(allStudents.map(s => s.course))].sort((a, b) => a - b);
      const courseSelect = document.getElementById('filter-student-course');
      courseSelect.innerHTML = '<option value="all">Todos los cursos</option>';
      courses.forEach(c => {
        courseSelect.innerHTML += `<option value="${c}">Curso ${c}</option>`;
      });
    }

    function displayCourseStats() {
      // Agrupar por grado y curso
      const courseGroups = {};
      
      allStudents.forEach(s => {
        const key = `${s.grade}-${s.course}`;
        if (!courseGroups[key]) {
          courseGroups[key] = { grade: s.grade, course: s.course, total: 0, voted: 0 };
        }
        courseGroups[key].total++;
        if (s.has_voted) courseGroups[key].voted++;
      });

      // Ordenar por grado y curso
      const sortedCourses = Object.values(courseGroups).sort((a, b) => {
        if (a.grade !== b.grade) return a.grade - b.grade;
        return a.course - b.course;
      });

      const container = document.getElementById('course-stats-container');
      container.innerHTML = `
        <div class="card" style="background: white; border: 2px solid #e2e8f0;">
          <h3 style="margin-bottom: 1rem; color: #1e293b;">üìä Participaci√≥n por Curso</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
            ${sortedCourses.map(c => {
              const percentage = c.total > 0 ? Math.round((c.voted / c.total) * 100) : 0;
              const isLow = percentage < 50;
              const bgColor = isLow ? '#fee2e2' : (percentage < 75 ? '#fef3c7' : '#dcfce7');
              const textColor = isLow ? '#991b1b' : (percentage < 75 ? '#92400e' : '#166534');
              const borderColor = isLow ? '#ef4444' : (percentage < 75 ? '#f59e0b' : '#22c55e');
              
              return `
                <div style="padding: 0.75rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 0.375rem;">
                  <div style="font-weight: 600; color: ${textColor}; margin-bottom: 0.25rem;">${c.grade === 0 ? 'Trans' : c.grade}-${c.course}</div>
                  <div style="font-size: 0.875rem; color: ${textColor};">
                    ${c.voted}/${c.total} votaron (${percentage}%)
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function applyStudentFilters() {
      const voteStatus = document.getElementById('filter-vote-status').value;
      const grade = document.getElementById('filter-student-grade').value;
      const course = document.getElementById('filter-student-course').value;
      const nameSearch = document.getElementById('filter-student-name').value.toLowerCase().trim();

      filteredStudents = allStudents.filter(s => {
        // Filtro de estado de voto
        if (voteStatus === 'voted' && !s.has_voted) return false;
        if (voteStatus === 'pending' && s.has_voted) return false;

        // Filtro de grado
        if (grade !== 'all' && s.grade !== parseInt(grade)) return false;

        // Filtro de curso
        if (course !== 'all' && s.course !== parseInt(course)) return false;

        // Filtro de nombre
        if (nameSearch && !s.full_name.toLowerCase().includes(nameSearch)) return false;

        return true;
      });

      displayFilteredStudents();
      updateFilterCounter();
    }

    function displayFilteredStudents() {
      const container = document.getElementById('students-table-container');
      
      if (filteredStudents.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">No se encontraron estudiantes con los filtros seleccionados.</p>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Grado</th>
              <th>Curso</th>
              <th>Lista</th>
              <th>Estado</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            ${filteredStudents.map(s => {
              const rowStyle = s.has_voted ? 'background: #dcfce7;' : '';
              return `
                <tr style="${rowStyle}">
                  <td><code style="font-weight: 600; color: #3b82f6;">${s.access_code}</code></td>
                  <td style="font-weight: 500;">${s.full_name}</td>
                  <td>${s.grade === 0 ? 'Trans.' : s.grade + '¬∞'}</td>
                  <td>${s.course}</td>
                  <td>${s.list_number}</td>
                  <td>${s.has_voted ? '<span style="color: #166534; font-weight: 600;">‚úÖ Vot√≥</span>' : '<span style="color: #64748b;">‚è≥ Pendiente</span>'}</td>
                  <td><button onclick="deleteStudent('${s.id}')" class="btn btn-danger" style="padding:0.25rem 0.5rem; font-size:0.875rem;">Eliminar</button></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function updateFilterCounter() {
      const counter = document.getElementById('filter-counter');
      const total = allStudents.length;
      const filtered = filteredStudents.length;
      
      if (filtered === total) {
        counter.innerHTML = `üìã Mostrando todos los estudiantes (${total})`;
        counter.style.background = '#dbeafe';
        counter.style.borderColor = '#3b82f6';
        counter.style.color = '#1e40af';
      } else {
        counter.innerHTML = `üîç Mostrando ${filtered} de ${total} estudiantes`;
        counter.style.background = '#fef3c7';
        counter.style.borderColor = '#f59e0b';
        counter.style.color = '#92400e';
      }
    }

    function clearStudentFilters() {
      document.getElementById('filter-vote-status').value = 'all';
      document.getElementById('filter-student-grade').value = 'all';
      document.getElementById('filter-student-course').value = 'all';
      document.getElementById('filter-student-name').value = '';
      applyStudentFilters();
    }

    function exportFilteredStudents() {
      if (filteredStudents.length === 0) {
        showToast('No hay estudiantes para exportar', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();
      const wsData = [
        ['C√≥digo', 'Nombre', 'Grado', 'Curso', 'Lista', 'Ha Votado'],
        ...filteredStudents.map(s => [
          s.access_code,
          s.full_name,
          s.grade,
          s.course,
          s.list_number,
          s.has_voted ? 'S√≠' : 'No'
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Estudiantes');
      XLSX.writeFile(wb, `estudiantes_filtrados_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Archivo exportado correctamente', 'success');
    }

    function printFilteredCarnets() {
      if (filteredStudents.length === 0) {
        showToast('No hay estudiantes para imprimir carnets', 'error');
        return;
      }
      
      // Cambiar a la pesta√±a de carnets con los filtros aplicados
      showSection('carnets', document.querySelector('[data-sec="carnets"]'));
      
      // Aplicar los mismos filtros en la secci√≥n de carnets
      setTimeout(() => {
        const voteStatus = document.getElementById('filter-vote-status').value;
        const grade = document.getElementById('filter-student-grade').value;
        const course = document.getElementById('filter-student-course').value;
        
        if (voteStatus !== 'all') document.getElementById('filter-status').value = voteStatus === 'voted' ? 'voted' : 'pending';
        if (grade !== 'all') document.getElementById('filter-grade').value = grade;
        if (course !== 'all') document.getElementById('filter-course').value = course;
        
        loadStudentsForCarnets();
      }, 100);
      
      showToast('Cambiando a secci√≥n de carnets con filtros aplicados', 'success');
    }

    function copyFilteredCodes() {
      if (filteredStudents.length === 0) {
        showToast('No hay c√≥digos para copiar', 'error');
        return;
      }

      const codes = filteredStudents.map(s => `${s.full_name}: ${s.access_code}`).join('\n');
      
      navigator.clipboard.writeText(codes).then(() => {
        showToast(`${filteredStudents.length} c√≥digos copiados al portapapeles`, 'success');
      }).catch(() => {
        // Fallback para navegadores que no soportan clipboard API
        const textarea = document.createElement('textarea');
        textarea.value = codes;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast(`${filteredStudents.length} c√≥digos copiados al portapapeles`, 'success');
      });
    }

    // ========== FUNCIONES PARA AGREGAR ESTUDIANTE MANUALMENTE ==========

    function openAddStudentModal() {
      document.getElementById('add-student-modal').classList.add('active');
      // Limpiar formulario
      document.getElementById('new-student-name').value = '';
      document.getElementById('new-student-grade').value = '';
      document.getElementById('new-student-course').value = '';
      document.getElementById('new-student-list-mode').value = 'auto';
      document.getElementById('new-student-list').value = '';
      document.getElementById('new-student-list').style.display = 'none';
      updateCodePreview();
    }

    function closeAddStudentModal() {
      document.getElementById('add-student-modal').classList.remove('active');
    }

    function toggleListInput() {
      const mode = document.getElementById('new-student-list-mode').value;
      const listInput = document.getElementById('new-student-list');
      
      if (mode === 'manual') {
        listInput.style.display = 'block';
        listInput.required = true;
      } else {
        listInput.style.display = 'none';
        listInput.required = false;
        listInput.value = '';
      }
      updateCodePreview();
    }

    function updateCodePreview() {
      const grade = document.getElementById('new-student-grade').value;
      const course = document.getElementById('new-student-course').value;
      const listMode = document.getElementById('new-student-list-mode').value;
      const listNumber = document.getElementById('new-student-list').value;
      
      const previewDisplay = document.getElementById('code-preview-display');
      
      if (grade === '' || grade === null || !course) {
        previewDisplay.textContent = '-----';
        previewDisplay.style.color = '#cbd5e1';
        return;
      }

      // Generar preview del c√≥digo
      const gradeStr = grade.padStart(2, '0');
      const courseStr = course;
      const listStr = listMode === 'manual' && listNumber ? listNumber.padStart(2, '0') : '??';
      
      const codePreview = `${gradeStr}${courseStr}${listStr}`;
      previewDisplay.textContent = codePreview;
      previewDisplay.style.color = listStr === '??' ? '#f59e0b' : '#3b82f6';
    }

    async function addStudentManually() {
      const name = document.getElementById('new-student-name').value.trim();
      const grade = document.getElementById('new-student-grade').value;
      const course = document.getElementById('new-student-course').value;
      const listMode = document.getElementById('new-student-list-mode').value;
      let listNumber = document.getElementById('new-student-list').value;

      // Validaciones
      if (!name) {
        showToast('Ingresa el nombre del estudiante', 'error');
        return;
      }

      if (grade === '' || grade === null || grade === undefined || !course) {
        showToast('Selecciona el grado y curso', 'error');
        return;
      }

      if (listMode === 'manual' && !listNumber) {
        showToast('Ingresa el n√∫mero de lista', 'error');
        return;
      }

      // Si es autoasignar, obtener el siguiente n√∫mero disponible
      if (listMode === 'auto') {
        const studentsInCourse = allStudents.filter(s => s.grade === parseInt(grade) && s.course === parseInt(course));
        if (studentsInCourse.length === 0) {
          listNumber = 1;
        } else {
          const maxList = Math.max(...studentsInCourse.map(s => s.list_number));
          listNumber = maxList + 1;
        }

        if (listNumber > 99) {
          showToast('No hay m√°s n√∫meros de lista disponibles para este curso (m√°ximo 99)', 'error');
          return;
        }
      }

      // Preparar datos - NO enviar list_number para que el backend lo genere autom√°ticamente
      const studentData = {
        full_name: name,
        grade: parseInt(grade),
        course: parseInt(course)
      };
      
      // Si es manual, incluir el list_number espec√≠fico (aunque el backend lo ignore por ahora)
      if (listMode === 'manual') {
        studentData.list_number = parseInt(listNumber);
      }

      try {
        const res = await fetch(`${API_URL}/admin/import`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-code': adminCode
          },
          body: JSON.stringify({
            students: [studentData]
          })
        });

        const result = await res.json();

        if (res.ok && result.success && result.imported > 0) {
          showToast(`‚úÖ Estudiante agregado: ${name}`, 'success');
          closeAddStudentModal();
          loadStudents();
        } else {
          const errMsg = result.error || (result.errors && result.errors[0]) || 'No se pudo agregar el estudiante';
          showToast(`Error: ${errMsg}`, 'error');
        }
      } catch (err) {
        console.error('Error:', err);
        showToast('Error de conexi√≥n al agregar estudiante', 'error');
      }
    }

    // Mostrar/ocultar bot√≥n flotante seg√∫n la secci√≥n activa
    function toggleFloatingButton(section) {
      const floatingBtn = document.getElementById('floating-add-student-btn');
      if (section === 'students') {
        floatingBtn.style.display = 'flex';
      } else {
        floatingBtn.style.display = 'none';
      }
    }

    // ========== FIN FUNCIONES AGREGAR ESTUDIANTE ==========

    async function deleteStudent(id) {
      if (!confirm('¬øEliminar este estudiante?')) return;
      try {
        const res = await fetch(`${API_URL}/admin/students`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ id, admin_code: adminCode })
        });
        if (res.ok) { showToast('Estudiante eliminado', 'success'); loadStudents(); }
        else showToast('Error al eliminar', 'error');
      } catch {
        showToast('Error al eliminar', 'error');
      }
    }

    // ========== RESTABLECER VOTACI√ìN ==========
    async function resetElectionVotes() {
      if (!confirm('‚ö†Ô∏è ¬øRestablecer la votaci√≥n?\n\nEsto restablecer√° todos los votos a cero sin eliminar estudiantes ni candidatos. Los c√≥digos de acceso se habilitar√°n nuevamente.')) {
        return;
      }

      const confirm2 = prompt('Escribe "RESTABLECER" para confirmar:');
      if (confirm2 !== 'RESTABLECER') {
        showToast('Operaci√≥n cancelada', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/admin/reset-votes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ admin_code: adminCode })
        });

        if (res.ok) {
          showToast('Votaci√≥n restablecida correctamente', 'success');
          loadDashboard();
          loadStudents();
        } else {
          showToast('Error al restablecer votaci√≥n', 'error');
        }
      } catch (err) {
        showToast('Error de conexi√≥n', 'error');
      }
    }

    async function resetCodes() {
      if (!confirm('¬øRegenerar todos los c√≥digos?')) return;
      try {
        const res = await fetch(`${API_URL}/admin/reset-codes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ admin_code: adminCode })
        });
        if (res.ok) { showToast('C√≥digos regenerados', 'success'); loadStudents(); }
        else showToast('Error', 'error');
      } catch {
        showToast('Error', 'error');
      }
    }

    async function clearStudents() {
      if (!confirm('‚ö†Ô∏è ¬øEliminar todos los estudiantes?\n\nEsto eliminar√° SOLO los estudiantes. Los candidatos, votos y configuraci√≥n se mantendr√°n.')) return;
      
      const c = prompt('Escribe ELIMINAR ESTUDIANTES para confirmar:');
      if (c !== 'ELIMINAR ESTUDIANTES') return;
      
      try {
        const res = await fetch(`${API_URL}/admin/clear-students`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ admin_code: adminCode })
        });
        if (res.ok) { showToast('Estudiantes eliminados', 'success'); location.reload(); }
        else showToast('Error al eliminar estudiantes', 'error');
      } catch {
        showToast('Error de conexi√≥n', 'error');
      }
    }

    async function loadCandidates() {
      try {
        const res = await fetch(`${API_URL}/admin/candidates`, { headers: { 'x-admin-code': adminCode } });
        const data = await res.json();

        const container = document.getElementById('candidates-list-admin');
        if (!data.candidates || data.candidates.length === 0) {
          container.innerHTML = '<p>No hay candidatos registrados</p>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead><tr><th>Foto</th><th>Nombre</th><th>Partido</th><th>Votos</th><th>Acciones</th></tr></thead>
            <tbody>
              ${data.candidates.map(c => `
                <tr>
                  <td>${c.photo_url ? `<img src="${c.photo_url}" class="candidate-photo" onerror="this.src='${generateInitialsAvatar(c.name, 60)}'">` : `<img src="${generateInitialsAvatar(c.name, 60)}" class="candidate-photo">`}</td>
                  <td><strong>${c.name}</strong></td>
                  <td>${c.party || '-'}</td>
                  <td>${c.votes}</td>
                  <td>
                    <button onclick="openEditPhotoModal('${c.id}', '${c.photo_url || ''}')" class="btn btn-warning" style="padding:0.25rem 0.5rem; font-size:0.875rem; margin-right:0.25rem;">Foto</button>
                    <button onclick="deleteCandidate('${c.id}')" class="btn btn-danger" style="padding:0.25rem 0.5rem; font-size:0.875rem;">Eliminar</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Error candidates:', err);
      }
    }

    /**
     * Abre el modal para editar la foto de un candidato
     */
    function openEditPhotoModal(candidateId, currentPhotoUrl) {
      document.getElementById('edit-candidate-id').value = candidateId;
      document.getElementById('edit-candidate-photo-data').value = '';
      document.getElementById('edit-candidate-photo-preview').style.display = 'none';
      document.getElementById('edit-photo-error').textContent = '';
      
      // Si hay una foto actual, mostrarla
      if (currentPhotoUrl) {
        const previewContainer = document.getElementById('edit-candidate-photo-preview');
        const previewImg = document.getElementById('edit-candidate-photo-img');
        previewImg.src = currentPhotoUrl;
        previewImg.onerror = function() {
          previewImg.src = generateInitialsAvatar('C', 150);
        };
        document.getElementById('edit-candidate-photo-filename').textContent = 'Foto actual (URL)';
        document.getElementById('edit-candidate-photo-filesize').textContent = 'N/A';
        previewContainer.style.display = 'flex';
      }
      
      document.getElementById('edit-photo-modal').classList.add('active');
    }

    /**
     * Cierra el modal de edici√≥n de foto
     */
    function closeEditPhotoModal() {
      document.getElementById('edit-photo-modal').classList.remove('active');
    }

    /**
     * Guarda la nueva foto del candidato
     */
    async function saveCandidatePhoto() {
      const candidateId = document.getElementById('edit-candidate-id').value;
      const photoData = document.getElementById('edit-candidate-photo-data').value;
      
      if (!photoData) {
        showToast('Selecciona una imagen primero', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/admin/candidates`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ id: candidateId, photo_url: photoData, admin_code: adminCode })
        });
        
        if (res.ok) {
          showToast('Foto actualizada correctamente', 'success');
          closeEditPhotoModal();
          loadCandidates();
        } else {
          showToast('Error al actualizar foto', 'error');
        }
      } catch {
        showToast('Error de conexi√≥n', 'error');
      }
    }

    async function addCandidate() {
      const name = document.getElementById('new-candidate-name').value.trim();
      const party = document.getElementById('new-candidate-party').value.trim();
      const photoData = document.getElementById('new-candidate-photo-data').value;

      if (!name) { showToast('Ingresa un nombre', 'warning'); return; }

      // Usar Base64 si hay archivo, sino usar URL legacy (vac√≠o por defecto)
      const photo_url = photoData || document.getElementById('new-candidate-photo-url-legacy')?.value || '';

      try {
        const res = await fetch(`${API_URL}/admin/candidates`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ name, party, photo_url, admin_code: adminCode })
        });

        if (res.ok) {
          document.getElementById('new-candidate-name').value = '';
          document.getElementById('new-candidate-party').value = '';
          // Limpiar imagen
          removeImage('new-candidate-photo-preview', 'new-candidate-photo-data');
          document.getElementById('new-candidate-photo-url-legacy').value = '';
          showToast('Candidato agregado', 'success');
          loadCandidates();
        } else {
          showToast('Error al crear candidato', 'error');
        }
      } catch {
        showToast('Error', 'error');
      }
    }

    async function deleteCandidate(id) {
      if (!confirm('¬øEliminar este candidato?')) return;
      try {
        const res = await fetch(`${API_URL}/admin/candidates`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ id, admin_code: adminCode })
        });
        if (res.ok) { showToast('Candidato eliminado', 'success'); loadCandidates(); }
        else showToast('Error', 'error');
      } catch {
        showToast('Error', 'error');
      }
    }

    // ========== GENERADOR DE CARNETS ==========
    async function initCarnetsSection() {
      await loadStudentsForCarnets();
    }

    async function loadStudentsForCarnets() {
      try {
        const res = await fetch(`${API_URL}/admin/students`, { headers: { 'x-admin-code': adminCode } });
        const data = await res.json();
        
        if (!data.students || data.students.length === 0) {
          document.getElementById('carnets-container').innerHTML = '<p style="color:#64748b; text-align:center; padding:2rem;">No hay estudiantes registrados</p>';
          return;
        }

        allStudentsForCarnets = data.students;
        
        // Llenar filtros de grado
        const gradeSelect = document.getElementById('filter-grade');
        const grades = [...new Set(data.students.map(s => s.grade))].sort((a,b) => a - b);
        gradeSelect.innerHTML = '<option value="all">Todos los grados</option>' + 
          grades.map(g => `<option value="${g}">${g === 0 ? 'Transici√≥n (0¬∞)' : 'Grado ' + g + '¬∞'}</option>`).join('');
        
        // Llenar filtros de curso
        const courseSelect = document.getElementById('filter-course');
        const courses = [...new Set(data.students.map(s => s.course))].sort((a,b) => a - b);
        courseSelect.innerHTML = '<option value="all">Todos los cursos</option>' + 
          courses.map(c => `<option value="${c}">Curso ${c}</option>`).join('');
        
        renderCarnets();
      } catch (err) {
        console.error('Error cargando estudiantes para carnets:', err);
        document.getElementById('carnets-container').innerHTML = '<p style="color:#ef4444;">Error al cargar estudiantes</p>';
      }
    }

    function renderCarnets() {
      const gradeFilter = document.getElementById('filter-grade').value;
      const courseFilter = document.getElementById('filter-course').value;
      const statusFilter = document.getElementById('filter-status').value;
      
      let filtered = allStudentsForCarnets;
      
      if (gradeFilter !== 'all') {
        filtered = filtered.filter(s => s.grade === parseInt(gradeFilter));
      }
      if (courseFilter !== 'all') {
        filtered = filtered.filter(s => s.course === parseInt(courseFilter));
      }
      if (statusFilter === 'pending') {
        filtered = filtered.filter(s => !s.has_voted);
      } else if (statusFilter === 'voted') {
        filtered = filtered.filter(s => s.has_voted);
      }

      const container = document.getElementById('carnets-container');
      
      if (filtered.length === 0) {
        container.innerHTML = '<p style="color:#64748b; text-align:center; padding:2rem;">No hay estudiantes que coincidan con los filtros</p>';
        return;
      }

      container.innerHTML = filtered.map(s => `
        <div class="carnet" id="carnet-${s.id}">
          <div class="carnet-header">
            <img src="${schoolConfig.school_logo_url || generatePlaceholderLogo()}" class="carnet-logo" onerror="this.src='${generatePlaceholderLogo()}'">
            <div>
              <div class="carnet-title">${schoolConfig.school_name || 'Colegio'}</div>
              <div class="carnet-subtitle">Carnet Electoral</div>
            </div>
          </div>
          <div class="carnet-info">
            <p><strong>Estudiante:</strong> ${s.full_name}</p>
            <p><strong>Grado:</strong> ${s.grade === 0 ? 'Transici√≥n' : s.grade + '¬∞'} | <strong>Curso:</strong> ${s.course}</p>
            <p><strong>Lista:</strong> ${s.list_number}</p>
          </div>
          <div class="carnet-code">${s.access_code}</div>
          <div class="carnet-qr-container" id="qr-container-${s.id}">
          </div>
          <div class="carnet-footer">
            Escanea el QR o usa el c√≥digo ‚Ä¢ Votaci√≥n ${new Date().getFullYear()}
          </div>
        </div>
      `).join('');
      
      // Generar QR codes despu√©s de renderizar
      setTimeout(() => {
        // Verificar si la librer√≠a QRCode est√° disponible
        if (typeof QRCode === 'undefined') {
          console.error('Librer√≠a QRCode no est√° cargada');
          showToast('Error: No se pudo cargar la librer√≠a de c√≥digos QR. Intenta recargar la p√°gina.', 'error');
          return;
        }
        
        filtered.forEach(s => {
          const container = document.getElementById(`qr-container-${s.id}`);
          if (container) {
            try {
              // Limpiar contenedor
              container.innerHTML = '';
              
              const baseURL = window.location.origin + window.location.pathname.replace('admin.html', 'index.html');
              const qrData = `${baseURL}?code=${s.access_code}`;
              
              // Generar QR usando QRCode.js
              new QRCode(container, {
                text: qrData,
                width: 120,
                height: 120,
                colorDark: '#1e293b',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
              });
            } catch (err) {
              console.error('Error generando QR para estudiante', s.full_name, ':', err);
              container.innerHTML = '<div style="font-size:0.7rem;color:#ef4444;text-align:center;">Error QR</div>';
            }
          }
        });
      }, 300);
    }

    function generatePlaceholderLogo() {
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50">
          <rect width="100%" height="100%" fill="#f1f5f9" rx="25"/>
          <path d="M25 8 L38 17 L38 33 L25 42 L12 33 L12 17 Z" fill="#3b82f6" opacity="0.3"/>
          <text x="25" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="#1e40af">‚òÖ</text>
        </svg>
      `);
    }

    function selectAllCarnets() {
      document.querySelectorAll('.carnet').forEach(c => {
        c.style.border = '2px solid #10b981';
        c.style.background = '#f0fdf4';
      });
      showToast('Todos los carnets seleccionados', 'success');
    }

    function deselectAllCarnets() {
      document.querySelectorAll('.carnet').forEach(c => {
        c.style.border = '2px solid #1e293b';
        c.style.background = 'white';
      });
      showToast('Selecci√≥n limpiada', 'info');
    }

    function printCarnets() {
      const container = document.getElementById('carnets-container');
      const printWindow = window.open('', '_blank');
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Impresi√≥n de Carnets Electorales</title>
          <style>
            @page { size: auto; margin: 15mm; }
            body { font-family: Arial, sans-serif; padding: 1rem; }
            .carnet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12mm; }
            .carnet { 
              border: 2px solid #1e293b; 
              border-radius: 0.5rem; 
              padding: 10px; 
              background: white;
              page-break-inside: avoid;
              width: 100%;
            }
            .carnet-header { display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 6px; margin-bottom: 8px; }
            .carnet-logo { width: 50px; height: 50px; border-radius: 50%; object-fit: contain; padding: 5px; background: #fff; border: 1px solid #e2e8f0; }
            .carnet-title { font-weight: bold; font-size: 0.75rem; color: #1e293b; }
            .carnet-subtitle { font-size: 0.65rem; color: #64748b; }
            .carnet-info { font-size: 0.7rem; }
            .carnet-code { 
              font-family: monospace; 
              font-size: 1.1rem; 
              font-weight: bold; 
              color: #3b82f6; 
              text-align: center; 
              padding: 4px; 
              background: #f1f5f9; 
              border-radius: 0.25rem; 
              margin-top: 4px; 
            }
            .carnet-qr-container {
              display: flex;
              justify-content: center;
              margin: 6px 0;
            }
            .carnet-qr-container img,
            .carnet-qr-container canvas {
              border: 2px solid #e2e8f0;
              border-radius: 0.25rem;
              max-width: 100px;
              height: auto;
            }
            .carnet-footer { 
              font-size: 0.6rem; 
              color: #94a3b8; 
              text-align: center; 
              margin-top: 6px; 
              padding-top: 4px; 
              border-top: 1px dashed #e2e8f0; 
            }
            @media print {
              .carnet-grid { grid-template-columns: repeat(2, 1fr); gap: 10mm; }
              .carnet { width: 100%; }
            }
          </style>
        </head>
        <body>
          <h2 style="text-align:center; margin-bottom:1rem;">üé¥ Carnets Electorales</h2>
          <div class="carnet-grid">
            ${container.innerHTML}
          </div>
        
<hr>
<h3>üîê Seguridad de Terminales de Voto</h3>

<label>Nueva contrase√±a de terminal:</label><br>
<input type="text" id="votePasswordInput" placeholder="Dejar vac√≠o para desactivar">
<button onclick="saveVotePassword()">Guardar</button>
<p id="votePasswordStatus"></p>

<script>
async function saveVotePassword() {
  const password = document.getElementById('votePasswordInput').value;

  const res = await fetch('/api/admin/set-vote-password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-admin-code': localStorage.getItem('admin_code')
    },
    body: JSON.stringify({ password })
  });

  if (res.ok) {
    document.getElementById('votePasswordStatus').innerText = 'Configuraci√≥n guardada';
  } else {
    document.getElementById('votePasswordStatus').innerText = 'Error al guardar';
  }
}
</script>

</body>
        </html>
      `);
      printWindow.document.close();
      setTimeout(() => printWindow.print(), 500);
    }

    function exportCarnetsPDF() {
      showToast('Generando PDF de carnets...', 'info');
      printCarnets();
    }

    // ========== IMPORTAR EXCEL ==========
    document.getElementById('excel-file')?.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('file-name').textContent = file.name;

      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          let data;
          const fileData = e.target.result;

          if (file.name.endsWith('.csv')) {
            const text = new TextDecoder('utf-8').decode(fileData);
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;
              const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
              const row = {};
              headers.forEach((h, idx) => row[h] = values[idx]);
              rows.push(row);
            }
            data = rows;
          } else {
            const workbook = XLSX.read(fileData, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            data = XLSX.utils.sheet_to_json(firstSheet);
          }

          processExcelData(data);
        } catch (err) {
          showToast('Error al leer archivo: ' + err.message, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function processExcelData(data) {
      if (!Array.isArray(data) || data.length === 0) {
        showToast('El archivo est√° vac√≠o o no tiene el formato correcto', 'warning');
        excelData = [];
        return;
      }

      const mapped = data.map((row) => {
        const findField = (possibleNames) => {
          for (const name of possibleNames) {
            if (row[name] !== undefined) return row[name];
            const key = Object.keys(row).find(k => k.toLowerCase().trim() === name.toLowerCase());
            if (key) return row[key];
          }
          return undefined;
        };

        const nombre = findField(['Nombre', 'Name', 'Estudiante', 'Alumno', 'Apellidos y Nombres', 'Apellido y Nombre', 'APELLIDOS Y NOMBRES', 'APELLIDO Y NOMBRE']);
        const grado = findField(['Grado', 'Grade', 'Nivel', 'A√±o', 'GRADO', 'Grado/Nivel', 'NIVEL']);
        const curso = findField(['Curso', 'Paralelo', 'Secci√≥n', 'Seccion', 'Course', 'CURSO', 'PARALELO', 'SECCION']);

        const gradeVal = grado !== undefined && grado !== null && String(grado).trim() !== '' ? parseInt(grado) : null;
        return {
          full_name: nombre ? String(nombre).trim() : '',
          grade: isNaN(gradeVal) ? null : gradeVal,
          course: parseInt(curso) || 1,
          list_number: 0
        };
      }).filter(s => s.full_name && s.grade !== null && s.grade >= 0);

      excelData = mapped;

      const preview = document.getElementById('import-preview');
      if (mapped.length === 0) {
        preview.innerHTML = `<div style="background:#fee2e2; border:2px solid #ef4444; color:#991b1b; padding:1rem; border-radius:0.5rem;">
          <strong>‚ö†Ô∏è No se encontraron estudiantes v√°lidos</strong><br>Columnas detectadas: ${Object.keys(data[0] || {}).join(', ')}
        </div>`;
        document.getElementById('btn-import').style.display = 'none';
        return;
      }

      preview.innerHTML = `
        <div style="background:#dcfce7; border:2px solid #22c55e; padding:1rem; border-radius:0.5rem; margin-bottom:1rem;">
          ‚úÖ <strong>${mapped.length} estudiantes v√°lidos encontrados</strong><br>
          <small>C√≥digos GGCLL: ejemplo grado 6 curso 1 lista 5 => 06105</small>
        </div>
        <h4>Vista previa (primeros 5):</h4>
        <table style="margin-top:0.5rem; font-size:0.875rem; width:100%;">
          <thead><tr><th>Nombre</th><th>Grado</th><th>Curso</th></tr></thead>
          <tbody>
            ${mapped.slice(0,5).map(s => `<tr><td>${s.full_name}</td><td>${s.grade}</td><td>${s.course}</td></tr>`).join('')}
            ${mapped.length > 5 ? `<tr><td colspan="3" style="text-align:center; color:#64748b; padding:0.5rem;">... y ${mapped.length-5} m√°s</td></tr>` : ''}
          </tbody>
        </table>
      `;

      document.getElementById('btn-import').style.display = 'block';
    }

    async function importStudents() {
      if (!excelData || excelData.length === 0) {
        showToast('No hay datos para importar', 'warning');
        return;
      }

      const btn = document.getElementById('btn-import');
      btn.disabled = true;
      btn.textContent = '‚è≥ Importando...';

      try {
        const studentsToSend = excelData.map(s => ({
          full_name: String(s.full_name || '').trim(),
          grade: parseInt(s.grade),
          course: parseInt(s.course) || 1,
          list_number: 0
        })).filter(s => s.full_name && !isNaN(s.grade) && s.grade >= 0);

        const res = await fetch(`${API_URL}/admin/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-admin-code': adminCode },
          body: JSON.stringify({ students: studentsToSend, admin_code: adminCode })
        });

        const result = await res.json();
        const resultDiv = document.getElementById('import-result');

        if (!res.ok || !result.success) {
          resultDiv.innerHTML = `<div style="background:#fee2e2; border:2px solid #ef4444; color:#991b1b; padding:1rem; border-radius:0.5rem; margin-top:1rem;">
            <strong>‚ùå Error:</strong> ${result.error || 'Error desconocido'}
          </div>`;
          showToast('Error al importar', 'error');
          return;
        }

        const skippedMsg = result.skipped > 0
          ? `<p><strong>‚ö†Ô∏è Ya exist√≠an (omitidos):</strong> ${result.skipped} estudiantes</p>`
          : '';
        const importedColor = result.imported > 0 ? '#dcfce7' : '#fef3c7';
        const importedBorder = result.imported > 0 ? '#22c55e' : '#f59e0b';
        resultDiv.innerHTML = `<div style="background:${importedColor}; border:2px solid ${importedBorder}; padding:1rem; border-radius:0.5rem; margin-top:1rem;">
          <h4>‚úÖ Importaci√≥n completada</h4>
          <p><strong>‚úÖ Nuevos importados:</strong> ${result.imported} estudiantes</p>
          ${skippedMsg}
          ${result.groups > 0 ? `<p><strong>Grupos (Grado-Curso):</strong> ${result.groups}</p>` : ''}
          ${result.message ? `<p style="color:#92400e;">${result.message}</p>` : ''}
        </div>`;

        const toastMsg = result.imported > 0
          ? `${result.imported} estudiantes importados${result.skipped > 0 ? `, ${result.skipped} omitidos (ya exist√≠an)` : ''}`
          : `Sin cambios: los ${result.skipped} estudiantes ya estaban registrados`;
        showToast(toastMsg, result.imported > 0 ? 'success' : 'warning');

        if (result.imported > 0 || result.skipped > 0) {
          excelData = [];
          document.getElementById('btn-import').style.display = 'none';
          document.getElementById('excel-file').value = '';
          document.getElementById('file-name').textContent = 'Ning√∫n archivo seleccionado';
          document.getElementById('import-preview').innerHTML = '';
        }
      } catch (err) {
        document.getElementById('import-result').innerHTML = `<div style="background:#fee2e2; border:2px solid #ef4444; color:#991b1b; padding:1rem; border-radius:0.5rem; margin-top:1rem;">
          <strong>‚ùå Error de conexi√≥n:</strong> ${err.message}
        </div>`;
        showToast('Error de conexi√≥n', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚úÖ Importar Estudiantes';
      }
    }

    // Permite enter en login
    document.getElementById('admin-code').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') login();
    });

    // Cerrar modal al hacer clic fuera
    document.getElementById('edit-photo-modal')?.addEventListener('click', function(e) {
      if (e.target === this) closeEditPhotoModal();
    });
  </script>

<hr>
<h3>üîê Seguridad de Terminales de Voto</h3>

<label>Nueva contrase√±a de terminal:</label><br>
<input type="text" id="votePasswordInput" placeholder="Dejar vac√≠o para desactivar">
<button onclick="saveVotePassword()">Guardar</button>
<p id="votePasswordStatus"></p>

<script>
async function saveVotePassword() {
  const password = document.getElementById('votePasswordInput').value;

  const res = await fetch('/api/admin/set-vote-password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-admin-code': localStorage.getItem('admin_code')
    },
    body: JSON.stringify({ password })
  });

  if (res.ok) {
    document.getElementById('votePasswordStatus').innerText = 'Configuraci√≥n guardada';
  } else {
    document.getElementById('votePasswordStatus').innerText = 'Error al guardar';
  }
}
</script>

</body>
</html>
